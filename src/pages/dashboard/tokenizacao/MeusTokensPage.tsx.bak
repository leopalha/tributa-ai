import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Input } from '@/components/ui/input';
import {
  BarChart3,
  Calendar,
  ChevronRight,
  Clock,
  Copy,
  Download,
  ExternalLink,
  Eye,
  FileText,
  Filter,
  PieChart,
  RefreshCw,
  Search,
  Share2,
  ShieldCheck,
  Tag,
  Wallet,
} from 'lucide-react';
import { formatCurrency } from '@/utils/format';

interface TokenData {
  id: string;
  nome: string;
  tipo: string;
  subtipo: string;
  valor: number;
  dataEmissao: Date;
  dataVencimento: Date;
  status: 'ativo' | 'listado' | 'vendido' | 'liquidado' | 'expirado';
  transactionHash: string;
  emissor: string;
  detentor: string;
  documentos: number;
  desconto: number;
  rendimento: number;
  rating: 'AAA' | 'AA' | 'A' | 'BBB' | 'BB' | 'B' | 'CCC' | 'CC' | 'C';
  blockchain: {
    rede: string;
    contrato: string;
    tokenId: string;
    confirmacoes: number;
  };
  marketplace: {
    listado: boolean;
    preco: number;
    visualizacoes: number;
    interessados: number;
    ofertasRecebidas: number;
  };
}

export default function MeusTokensPage() {
  const [tokens, setTokens] = useState<TokenData[]>([]);
  const [filteredTokens, setFilteredTokens] = useState<TokenData[]>([]);
  const [activeTab, setActiveTab] = useState('todos');
  const [searchTerm, setSearchTerm] = useState('');
  const [loading, setLoading] = useState(true);
  const [showFilters, setShowFilters] = useState(false);
  const [filterOptions, setFilterOptions] = useState({
    tipo: '',
    subtipo: '',
    rating: '',
    dataInicio: '',
    dataFim: '',
    valorMin: '',
    valorMax: ''
  });

  useEffect(() => {
    loadTokens();
  }, []);

  useEffect(() => {
    applyFilters();
  }, [tokens, activeTab, searchTerm, showFilters, filterOptions]);

  const loadTokens = async () => {
    setLoading(true);
    
    // Simular carregamento de dados
    setTimeout(() => {
      const mockTokens: TokenData[] = [
        {
          id: 'TK-2025-0001',
          nome: 'Crédito ICMS SP Q1/2025',
          tipo: 'tributario',
          subtipo: 'estadual',
          valor: 187500.00,
          dataEmissao: new Date('2025-01-15'),
          dataVencimento: new Date('2025-12-31'),
          status: 'ativo',
          transactionHash: '0x8f7d8c9b3a2e1f4d5c6b7a8e9d0f1e2d3c4b5a6e7f8d9c0b1a2e3f4d5c6b7a8e9',
          emissor: 'Empresa ABC Ltda',
          detentor: 'Empresa ABC Ltda',
          documentos: 5,
          desconto: 0,
          rendimento: 0,
          rating: 'AA',
          blockchain: {
            rede: 'Hyperledger Fabric',
            contrato: 'tributatoken',
            tokenId: 'TC-ICMS-SP-2025-0001',
            confirmacoes: 24,
          },
          marketplace: {
            listado: false,
            preco: 0,
            visualizacoes: 0,
            interessados: 0,
            ofertasRecebidas: 0,
          },
        },
        {
          id: 'TK-2025-0002',
          nome: 'Precatório Federal TRF-3',
          tipo: 'judicial',
          subtipo: 'precatorio_comum',
          valor: 432000.00,
          dataEmissao: new Date('2025-02-03'),
          dataVencimento: new Date('2026-06-30'),
          status: 'listado',
          transactionHash: '0x7e6d5c4b3a2f1e0d9c8b7a6e5d4c3b2a1f0e9d8c7b6a5e4d3c2b1a0f9e8d7c6b5',
          emissor: 'União Federal',
          detentor: 'Empresa ABC Ltda',
          documentos: 8,
          desconto: 12.5,
          rendimento: 15.2,
          rating: 'AAA',
          blockchain: {
            rede: 'Hyperledger Fabric',
            contrato: 'tributatoken',
            tokenId: 'TC-PREC-FED-2025-0002',
            confirmacoes: 32,
          },
          marketplace: {
            listado: true,
            preco: 378000.00,
            visualizacoes: 27,
            interessados: 3,
            ofertasRecebidas: 1,
          },
        },
        {
          id: 'TK-2025-0003',
          nome: 'Duplicata Mercantil #45782',
          tipo: 'comercial',
          subtipo: 'duplicata_mercantil',
          valor: 75000.00,
          dataEmissao: new Date('2025-02-28'),
          dataVencimento: new Date('2025-04-30'),
          status: 'vendido',
          transactionHash: '0x5a4b3c2d1e0f9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3',
          emissor: 'Empresa ABC Ltda',
          detentor: 'XYZ Investimentos',
          documentos: 3,
          desconto: 8.2,
          rendimento: 0,
          rating: 'A',
          blockchain: {
            rede: 'Hyperledger Fabric',
            contrato: 'tributatoken',
            tokenId: 'TC-DUPL-MERC-2025-0003',
            confirmacoes: 48,
          },
          marketplace: {
            listado: false,
            preco: 68850.00,
            visualizacoes: 15,
            interessados: 2,
            ofertasRecebidas: 2,
          },
        },
        {
          id: 'TK-2024-0015',
          nome: 'Crédito PIS/COFINS',
          tipo: 'tributario',
          subtipo: 'federal',
          valor: 128750.00,
          dataEmissao: new Date('2024-11-10'),
          dataVencimento: new Date('2025-11-10'),
          status: 'ativo',
          transactionHash: '0x2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c',
          emissor: 'Empresa ABC Ltda',
          detentor: 'Empresa ABC Ltda',
          documentos: 6,
          desconto: 0,
          rendimento: 0,
          rating: 'A',
          blockchain: {
            rede: 'Hyperledger Fabric',
            contrato: 'tributatoken',
            tokenId: 'TC-PIS-COFINS-2024-0015',
            confirmacoes: 128,
          },
          marketplace: {
            listado: false,
            preco: 0,
            visualizacoes: 0,
            interessados: 0,
            ofertasRecebidas: 0,
          },
        },
        {
          id: 'TK-2024-0008',
          nome: 'Crédito IRPJ 2024',
          tipo: 'tributario',
          subtipo: 'federal',
          valor: 95000.00,
          dataEmissao: new Date('2024-08-15'),
          dataVencimento: new Date('2025-08-15'),
          status: 'liquidado',
          transactionHash: '0x1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b',
          emissor: 'Empresa ABC Ltda',
          detentor: 'Empresa ABC Ltda',
          documentos: 4,
          desconto: 0,
          rendimento: 0,
          rating: 'A',
          blockchain: {
            rede: 'Hyperledger Fabric',
            contrato: 'tributatoken',
            tokenId: 'TC-IRPJ-2024-0008',
            confirmacoes: 256,
          },
          marketplace: {
            listado: false,
            preco: 0,
            visualizacoes: 0,
            interessados: 0,
            ofertasRecebidas: 0,
          },
        },
      ];

      setTokens(mockTokens);
      setLoading(false);
    }, 1000);
  };

  const applyFilters = () => {
    let filtered = [...tokens];
    
    // Filtrar por status
    if (activeTab !== 'todos') {
      filtered = filtered.filter(token => token.status === activeTab);
    }
    
    // Filtrar por termo de busca
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      filtered = filtered.filter(token => 
        token.nome.toLowerCase().includes(term) ||
        token.id.toLowerCase().includes(term) ||
        token.tipo.toLowerCase().includes(term) ||
        token.subtipo.toLowerCase().includes(term) ||
        token.emissor.toLowerCase().includes(term)
      );
    }
    
    // Aplicar filtros avançados
    if (showFilters) {
      if (filterOptions.tipo) {
        filtered = filtered.filter(token => token.tipo === filterOptions.tipo);
      }
      
      if (filterOptions.subtipo) {
        filtered = filtered.filter(token => token.subtipo === filterOptions.subtipo);
      }
      
      if (filterOptions.rating) {
        filtered = filtered.filter(token => token.rating === filterOptions.rating);
      }
      
      if (filterOptions.valorMin) {
        const min = parseFloat(filterOptions.valorMin);
        if (!isNaN(min)) {
          filtered = filtered.filter(token => token.valor >= min);
        }
      }
      
      if (filterOptions.valorMax) {
        const max = parseFloat(filterOptions.valorMax);
        if (!isNaN(max)) {
          filtered = filtered.filter(token => token.valor <= max);
        }
      }
      
      if (filterOptions.dataInicio) {
        const dataInicio = new Date(filterOptions.dataInicio);
        filtered = filtered.filter(token => token.dataEmissao >= dataInicio);
      }
      
      if (filterOptions.dataFim) {
        const dataFim = new Date(filterOptions.dataFim);
        filtered = filtered.filter(token => token.dataVencimento <= dataFim);
      }
    }
    
    setFilteredTokens(filtered);
  };

  const getStatusBadge = (status: TokenData['status']) => {
    switch (status) {
      case 'ativo':
        return <Badge className="bg-green-100 text-green-800">Ativo</Badge>;
      case 'listado':
        return <Badge className="bg-blue-100 text-blue-800">Listado</Badge>;
      case 'vendido':
        return <Badge className="bg-purple-100 text-purple-800">Vendido</Badge>;
      case 'liquidado':
        return <Badge className="bg-gray-100 text-gray-800">Liquidado</Badge>;
      case 'expirado':
        return <Badge className="bg-red-100 text-red-800">Expirado</Badge>;
      default:
        return <Badge className="bg-gray-100 text-gray-800">{status}</Badge>;
    }
  };

  const getTipoIcon = (tipo: string) => {
    switch (tipo) {
      case 'tributario':
        return <FileText className="w-4 h-4 text-blue-600" />;
      case 'judicial':
        return <ShieldCheck className="w-4 h-4 text-purple-600" />;
      case 'comercial':
        return <Tag className="w-4 h-4 text-orange-600" />;
      default:
        return <FileText className="w-4 h-4 text-gray-600" />;
    }
  };

  const formatDate = (date: Date) => {
    return date.toLocaleDateString('pt-BR');
  };
  
  // Funções para os botões
  const handleViewDetails = (token: TokenData) => {
    console.log('Visualizando detalhes do token:', token.id);
    // Implementar navegação para página de detalhes
    // router.push(`/dashboard/tokenizacao/token/${token.id}`);
  };
  
  const handleListOnMarketplace = (token: TokenData) => {
    console.log('Listando token no marketplace:', token.id);
    // Implementar navegação para página de listagem
    // router.push(`/dashboard/tokenizacao/listar/${token.id}`);
  };
  
  const handleViewOnMarketplace = (token: TokenData) => {
    console.log('Visualizando token no marketplace:', token.id);
    // Implementar navegação para página do marketplace
    // router.push(`/dashboard/marketplace/token/${token.id}`);
  };
  
  const handleDownloadCertificate = (token: TokenData) => {
    console.log('Baixando certificado do token:', token.id);
    // Implementar download do certificado
  };
  
  const handleViewOnBlockchain = (token: TokenData) => {
    console.log('Visualizando token na blockchain:', token.transactionHash);
    // Abrir explorador da blockchain em nova janela
    window.open(`https://explorer.blockchain.com/tx/${token.transactionHash}`, '_blank');
  };
  
  const handleGenerateReports = () => {
    console.log('Gerando relatórios de tokens');
    // Implementar geração de relatórios
  };

  const getRatingColor = (rating: TokenData['rating']) => {
    if (rating.startsWith('AAA') || rating.startsWith('AA')) return 'text-green-600';
    if (rating.startsWith('A') || rating.startsWith('BBB')) return 'text-blue-600';
    if (rating.startsWith('BB') || rating.startsWith('B')) return 'text-yellow-600';
    return 'text-red-600';
  };

  const getTokenStats = () => {
    const total = tokens.length;
    const ativos = tokens.filter(t => t.status === 'ativo').length;
    const listados = tokens.filter(t => t.status === 'listado').length;
    const vendidos = tokens.filter(t => t.status === 'vendido').length;
    const liquidados = tokens.filter(t => t.status === 'liquidado').length;
    const expirados = tokens.filter(t => t.status === 'expirado').length;
    
    const valorTotal = tokens.reduce((sum, token) => sum + token.valor, 0);
    
    return {
      total,
      ativos,
      listados,
      vendidos,
      liquidados,
      expirados,
      valorTotal
    };
  };

  const stats = getTokenStats();

  return (
    <div className="p-6 space-y-6">
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Meus Tokens</h1>
          <p className="text-gray-600">
            Gerencie seus títulos de crédito tokenizados
          </p>
        </div>
        <div className="flex flex-col sm:flex-row items-center gap-3">
          <div className="relative w-full sm:w-auto">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
            <Input
              placeholder="Buscar tokens..."
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
              className="pl-10 w-full sm:w-64"
            />
          </div>
          <Button variant="outline" size="sm" onClick={loadTokens} disabled={loading}>
            {loading ? (
              <RefreshCw className="w-4 h-4 animate-spin mr-2" />
            ) : (
              <RefreshCw className="w-4 h-4 mr-2" />
            )}
            Atualizar
          </Button>
          <Button>
            <PieChart className="w-4 h-4 mr-2" />
            Relatórios
          </Button>
        </div>
      </div>

      {/* Estatísticas */}
      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <Card>
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total de Tokens</p>
                <p className="text-2xl font-bold text-gray-900">{stats.total}</p>
              </div>
              <div className="p-2 rounded-full bg-gray-100">
                <Wallet className="w-5 h-5 text-gray-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Valor Total</p>
                <p className="text-2xl font-bold text-gray-900">{formatCurrency(stats.valorTotal)}</p>
              </div>
              <div className="p-2 rounded-full bg-blue-100">
                <BarChart3 className="w-5 h-5 text-blue-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Ativos</p>
                <p className="text-2xl font-bold text-green-600">{stats.ativos}</p>
              </div>
              <div className="p-2 rounded-full bg-green-100">
                <ShieldCheck className="w-5 h-5 text-green-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Listados</p>
                <p className="text-2xl font-bold text-blue-600">{stats.listados}</p>
              </div>
              <div className="p-2 rounded-full bg-blue-100">
                <Tag className="w-5 h-5 text-blue-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Vendidos</p>
                <p className="text-2xl font-bold text-purple-600">{stats.vendidos}</p>
              </div>
              <div className="p-2 rounded-full bg-purple-100">
                <Share2 className="w-5 h-5 text-purple-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Liquidados</p>
                <p className="text-2xl font-bold text-gray-600">{stats.liquidados}</p>
              </div>
              <div className="p-2 rounded-full bg-gray-100">
                <Clock className="w-5 h-5 text-gray-600" />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Tabs e Lista de Tokens */}
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <div className="flex items-center justify-between">
          <TabsList>
            <TabsTrigger value="todos">Todos ({stats.total})</TabsTrigger>
            <TabsTrigger value="ativo">Ativos ({stats.ativos})</TabsTrigger>
            <TabsTrigger value="listado">Listados ({stats.listados})</TabsTrigger>
            <TabsTrigger value="vendido">Vendidos ({stats.vendidos})</TabsTrigger>
            <TabsTrigger value="liquidado">Liquidados ({stats.liquidados})</TabsTrigger>
          </TabsList>

          <Button variant="outline" size="sm">
            <Filter className="w-4 h-4 mr-2" />
            Filtros Avançados
          </Button>
        </div>

        <TabsContent value={activeTab} className="mt-6">
          {loading ? (
            <div className="flex justify-center items-center py-12">
              <RefreshCw className="w-8 h-8 animate-spin text-gray-400" />
            </div>
          ) : filteredTokens.length === 0 ? (
            <div className="text-center py-12">
              <p className="text-gray-500">Nenhum token encontrado</p>
            </div>
          ) : (
            <div className="space-y-4">
              {filteredTokens.map(token => (
                <Card key={token.id} className="overflow-hidden hover:shadow-md transition-shadow">
                  <div className="flex flex-col md:flex-row">
                    <div className="flex-1 p-6">
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                          {getTipoIcon(token.tipo)}
                          <h3 className="font-semibold text-lg text-gray-900">{token.nome}</h3>
                        </div>
                        {getStatusBadge(token.status)}
                      </div>

                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div>
                          <p className="text-sm text-gray-500">ID do Token</p>
                          <p className="font-medium">{token.id}</p>
                        </div>
                        <div>
                          <p className="text-sm text-gray-500">Valor</p>
                          <p className="font-medium">{formatCurrency(token.valor)}</p>
                        </div>
                        <div>
                          <p className="text-sm text-gray-500">Emissão</p>
                          <p className="font-medium">{formatDate(token.dataEmissao)}</p>
                        </div>
                        <div>
                          <p className="text-sm text-gray-500">Vencimento</p>
                          <p className="font-medium">{formatDate(token.dataVencimento)}</p>
                        </div>
                      </div>

                      <div className="flex flex-wrap gap-2 mb-2">
                        <Badge variant="outline" className="bg-gray-50">
                          {token.tipo.charAt(0).toUpperCase() + token.tipo.slice(1)}
                        </Badge>
                        <Badge variant="outline" className="bg-gray-50">
                          {token.subtipo.replace('_', ' ')}
                        </Badge>
                        <Badge variant="outline" className={`font-semibold ${getRatingColor(token.rating)}`}>
                          {token.rating}
                        </Badge>
                        {token.marketplace.listado && (
                          <Badge variant="outline" className="bg-blue-50 text-blue-800">
                            Marketplace
                          </Badge>
                        )}
                      </div>

                      <div className="text-sm text-gray-500 flex items-center gap-1">
                        <Copy className="w-3 h-3" />
                        <span className="truncate max-w-xs">{token.transactionHash}</span>
                      </div>
                    </div>

                    <div className="bg-gray-50 p-6 flex flex-col justify-center space-y-3 md:w-64">
                      <Button className="w-full">
                        <Eye className="w-4 h-4 mr-2" />
                        Detalhes
                      </Button>
                      
                      {token.status === 'ativo' && !token.marketplace.listado && (
                        <Button variant="outline" className="w-full">
                          <Tag className="w-4 h-4 mr-2" />
                          Listar no Marketplace
                        </Button>
                      )}
                      
                      {token.status === 'listado' && (
                        <Button variant="outline" className="w-full">
                          <Eye className="w-4 h-4 mr-2" />
                          Ver no Marketplace
                        </Button>
                      )}
                      
                      <Button variant="outline" className="w-full">
                        <Download className="w-4 h-4 mr-2" />
                        Baixar Certificado
                      </Button>
                      
                      <Button variant="ghost" className="w-full">
                        <ExternalLink className="w-4 h-4 mr-2" />
                        Ver na Blockchain
                      </Button>
                    </div>
                  </div>
                </Card>
              ))}
            </div>
          )}
        </TabsContent>
      </Tabs>
    </div>
  );
}